好，这一步我们直接把 **588080 Top10 成分股 & 权重**做成**“可长期维护 + 可被回测引擎/前端直接吃”的工程级设计**。
我会分 **表结构 → 数据来源策略 → 使用方式** 三层来讲。

---

# 一、设计目标（先对齐认知）

这张表 **不是展示表**，而是：

> **ETF 成分股共振计算的“权重基准表”**

所以必须满足：

* ✅ 支持 **历史回测**（不能只存最新）
* ✅ 支持 **Top10 / TopN**
* ✅ 权重可变（指数调仓）
* ✅ 查询快（回测会频繁用）

---

# 二、核心表结构设计（推荐）

## ✅ 表名：`etf_constituents`

> 一张表就够，不要过度拆

```sql
CREATE TABLE etf_constituents (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',

  etf_code VARCHAR(10) NOT NULL COMMENT 'ETF代码，如 588080',
  stock_code VARCHAR(10) NOT NULL COMMENT '成分股代码',
  stock_name VARCHAR(50) NOT NULL COMMENT '成分股名称',

  weight DECIMAL(6,4) NOT NULL COMMENT '权重，如 0.0825 = 8.25%',
  rank INT NOT NULL COMMENT '在ETF中的权重排名（1=最大）',

  effective_date DATE NOT NULL COMMENT '权重生效日期',
  expire_date DATE DEFAULT NULL COMMENT '权重失效日期（NULL=当前有效）',

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  KEY idx_etf_date (etf_code, effective_date),
  KEY idx_etf_rank (etf_code, rank),
  KEY idx_stock (stock_code)
) COMMENT='ETF成分股及权重（支持历史）';
```

---

# 三、588080 Top10 示例数据（示意）

> ⚠️ **这里只是结构示例，不是实时权重**

| rank | stock_code | stock_name | weight |
| ---- | ---------- | ---------- | ------ |
| 1    | 688981     | 中芯国际       | 0.0850 |
| 2    | 688041     | 海光信息       | 0.0720 |
| 3    | 688256     | 寒武纪        | 0.0610 |
| 4    | 688012     | 中微公司       | 0.0540 |
| 5    | 688036     | 传音控股       | 0.0430 |
| 6    | 688599     | 天合光能       | 0.0410 |
| 7    | 688111     | 金山办公       | 0.0390 |
| 8    | 688009     | 中国通号       | 0.0360 |
| 9    | 688082     | 盛美上海       | 0.0320 |
| 10   | 688390     | 固德威        | 0.0290 |

👉 **Top10 权重合计 ≈ 49%–55%（非常关键）**

---

# 四、为什么要有 effective / expire（非常重要）

### ❌ 常见坑

* 只存“当前 Top10”
* 回测用的是 **未来权重**

### ✅ 正确做法

* 每次指数调仓 → 插一批新记录
* 老记录填 `expire_date`

这样你回测时可以：

```sql
SELECT *
FROM etf_constituents
WHERE etf_code = '588080'
  AND effective_date <= :tradeDate
  AND (expire_date IS NULL OR expire_date > :tradeDate)
  AND rank <= 10;
```

📌 **这一步直接决定你回测是不是“作弊”**

---

# 五、服务层封装（NestJS）

## ETFConstituentsService

```ts
getTopConstituents(
  etfCode: string,
  date: string,
  topN = 10
) {
  return this.repo.find({
    where: {
      etfCode,
      effectiveDate: LessThanOrEqual(date),
      expireDate: IsNull() || MoreThan(date)
    },
    order: { rank: 'ASC' },
    take: topN
  })
}
```

---

# 六、如何被「共振指标」直接使用

在回测引擎中：

```ts
const constituents = ctx.market.getETFConstituents(
  '588080',
  ctx.date,
  10
)
```

每一项你就有：

```ts
{
  stockCode,
  weight,
  rank
}
```

直接算：

* 上涨数量
* 上涨权重和
* Top5 是否同时为正

---

# 七、前端展示（顺手但很加分）

你可以在策略页加一个 **“成分股共振卡片”**：

```
中芯国际   ████████  +1.2%
海光信息   ██████    +0.8%
寒武纪     █████     -0.3%
...
共振评分：0.71 ✅
```

👉 **这会让你这个系统非常“像专业投研平台”**

---

# 八、进阶但不急（先别做）

* 成分股 **分钟级权重加权涨幅**
* 动态 TopN（按权重阈值）
* 行业子共振（半导体 / AI）

这些都可以在 **V2**。

---

## 总结一句话（你现在这一步很关键）

> **ETF 共振不是“看板块”，
> 而是“用权重把注意力集中在真正能推动 ETF 的几只股票上”。**

你这个 Top10 + 权重表一旦立住，
后面的共振评分、胜率提升，都会**非常顺**。

---

### 下一步我建议你直接干的（最优路径）

1️⃣ **成分股分钟行情 Provider 设计**
2️⃣ **共振评分写入 strategy_indicators 表**
3️⃣ **加共振过滤前后的回测对比**

你选一个，我直接继续给你写到代码级。
