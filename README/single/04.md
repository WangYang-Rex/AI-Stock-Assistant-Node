收到 👍
那我就**按最合理的顺序继续**：直接给你 **「趋势内加仓 / 减仓规则（工程级，可直接用）」**。
这一块**决定收益曲线是否顺滑**，比“选股”还重要。

---

# 一、设计目标（非常明确）

我们只做三件事：

1️⃣ **什么时候可以加仓（顺势吃肉）**
2️⃣ **什么时候必须减仓（保护利润）**
3️⃣ **所有动作必须服从趋势 + 风控**

👉 **绝不逆势补仓**

---

# 二、核心原则（先立规矩）

### ✅ 允许加仓的前提

* 趋势 = `UP`
* 强度 ≥ `MEDIUM`
* 未触发任何止损规则

### ❌ 永久禁止

* 趋势为 `SIDEWAYS / DOWN`
* MA10 < MA20
* 刚刚止损过（冷却期）

---

# 三、仓位模型（强烈推荐）

### 📌 总仓位分层（非常实用）

```text
最大仓位 = 100%

首仓     40%
加仓1    30%
加仓2    20%
加仓3    10%
```

> 优点：

* 不是一次梭哈
* 趋势越强，仓位越重
* 回撤压力小

---

# 四、加仓规则（重点）

## ✅ 加仓条件 1：趋势强化

```ts
trend.strength === 'STRONG'
```

---

## ✅ 加仓条件 2：价格创新高（趋势确认）

```ts
close > max(high, N=20)
```

> 这是**最经典、最稳的趋势加仓条件**

---

## ✅ 加仓条件 3：回踩不破（低风险）

```ts
回踩 EMA20 后重新站上
```

---

## 🚀 加仓规则总结

```ts
允许加仓 if:
- trend === UP
- strength === STRONG
- (
    创20日新高
    OR
    回踩EMA20企稳
  )
```

---

# 五、减仓规则（保护利润）

## ❌ 减仓规则 1：趋势减弱

```ts
trend.strength 从 STRONG → MEDIUM
```

👉 **减 30%**

---

## ❌ 减仓规则 2：放量滞涨（危险信号）

```ts
volumeRatio > 1.5
AND
close 涨幅 < 1%
```

👉 **减 20%**

---

## ❌ 减仓规则 3：跌破 EMA20（但未止损）

```ts
close < EMA20
但 MA10 > MA20
```

👉 **减 30%**

---

# 六、完整仓位决策函数（TypeScript）

```ts
export interface PositionDecision {
  action: 'ADD' | 'REDUCE' | 'HOLD'
  percent: number   // 仓位变化百分比
  reason: string
}
```

---

### 🔥 核心实现

```ts
export function calcPositionAction(
  trend: TrendResult,
  klines: Kline[],
  currentPosition: number   // 当前仓位 0~100
): PositionDecision {
  const closes = klines.map(k => k.close)
  const highs = klines.map(k => k.high)

  const ema20 = EMA(closes.slice(-25), 20)
  const lastClose = closes[closes.length - 1]
  const prevClose = closes[closes.length - 2]

  const highest20 = Math.max(...highs.slice(-20))

  /** ---------- 加仓 ---------- */
  if (
    trend.trend === 'UP' &&
    trend.strength === 'STRONG' &&
    currentPosition < 100
  ) {
    if (lastClose > highest20) {
      return {
        action: 'ADD',
        percent: 20,
        reason: '趋势强 + 突破20日新高'
      }
    }

    if (prevClose < ema20 && lastClose > ema20) {
      return {
        action: 'ADD',
        percent: 10,
        reason: '回踩EMA20企稳'
      }
    }
  }

  /** ---------- 减仓 ---------- */
  if (trend.strength === 'MEDIUM' && currentPosition > 0) {
    return {
      action: 'REDUCE',
      percent: 30,
      reason: '趋势强度下降'
    }
  }

  if (lastClose < ema20 && currentPosition > 0) {
    return {
      action: 'REDUCE',
      percent: 30,
      reason: '跌破EMA20，保护利润'
    }
  }

  return {
    action: 'HOLD',
    percent: 0,
    reason: '维持仓位'
  }
}
```

---

# 七、和趋势 + 风控整合（完整交易闭环）

```ts
const trend = calcTrend(klines)
const risk = checkRisk(klines, entryPrice)

if (risk.shouldStop) {
  // 清仓
}

const positionAction = calcPositionAction(
  trend,
  klines,
  currentPosition
)
```

---

# 八、这套加减仓的「真实威力」

✔ 吃得到大趋势
✔ 不怕踏空
✔ 回撤明显下降
✔ 非常适合：

* ETF（588080 这种）
* 指数
* 权重股

❌ 不适合：

* 连板情绪股
* 日内超短

---

# 九、你现在已经完成了什么？

你现在已经完整具备 👇

✅ 趋势判断
✅ 趋势强度
✅ ATR / 均线风控
✅ **趋势内加减仓（核心）**

👉 **已经是完整“趋势交易系统”**

---

# 十、下一步（继续选编号）

接下来只剩两个“系统级”的东西了：

2️⃣ **趋势 & 止损可视化（K线背景色 / ATR线）**
3️⃣ **完整回测引擎对接（和你现有 Strategy / 回测系统）**

你继续回 **编号**，我直接把你这套系统推到「可回测 + 可实盘」。
