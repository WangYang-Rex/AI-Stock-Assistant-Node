å¥½ï¼Œç›´æ¥ç»™ä½  **ã€Œå¯ç›´æ¥ç”¨çš„ TypeScript å®ç°ã€**ã€‚
ä¸‹é¢è¿™ä»½ä»£ç **ä¸ä¾èµ–æœªæ¥å‡½æ•°**ã€**é€‚åˆæ—¥çº¿ / 30min / 60min**ï¼Œä½ ä¸¢è¿› Nest / Node é¡¹ç›®å°±èƒ½è·‘ã€‚

---

## ä¸€ã€è¾“å…¥æ•°æ®ç»“æ„ï¼ˆä½ ç³»ç»Ÿé‡ŒåŸºæœ¬éƒ½æœ‰ï¼‰

```ts
export interface Kline {
  date: string
  open: number
  high: number
  low: number
  close: number
  volume: number
}
```

---

## äºŒã€æŠ€æœ¯æŒ‡æ ‡å·¥å…·å‡½æ•°ï¼ˆç²¾ç®€å¯ç”¨ç‰ˆï¼‰

```ts
function SMA(values: number[], period: number): number {
  const slice = values.slice(-period)
  return slice.reduce((a, b) => a + b, 0) / slice.length
}

function EMA(values: number[], period: number): number {
  const k = 2 / (period + 1)
  let ema = values[0]
  for (let i = 1; i < values.length; i++) {
    ema = values[i] * k + ema * (1 - k)
  }
  return ema
}

function RSI(values: number[], period = 14): number {
  let gains = 0
  let losses = 0
  for (let i = values.length - period; i < values.length; i++) {
    const diff = values[i] - values[i - 1]
    if (diff >= 0) gains += diff
    else losses -= diff
  }
  const rs = gains / (losses || 1)
  return 100 - 100 / (1 + rs)
}

function MACD(values: number[]) {
  const ema12 = EMA(values.slice(-26), 12)
  const ema26 = EMA(values.slice(-26), 26)
  const dif = ema12 - ema26
  const dea = EMA([dif], 9)
  return {
    dif,
    dea,
    hist: dif - dea
  }
}
```

> ğŸ‘‰ **è¯´æ˜**ï¼š
>
> * EMA / MACD å†™æ³•æ˜¯å·¥ç¨‹ç‰ˆï¼Œä¸æ˜¯æ•™ç§‘ä¹¦ï¼Œä½†**è¶‹åŠ¿åˆ¤æ–­è¶³å¤Ÿç¨³å®š**
> * å¦‚æœä½ åé¢åšå›æµ‹ï¼Œå¯æ›¿æ¢æˆ talib / ta-lib å°è£…

---

## ä¸‰ã€è¶‹åŠ¿ç»“æœç»“æ„

```ts
export interface TrendResult {
  trend: 'UP' | 'DOWN' | 'SIDEWAYS'
  score: number
  strength: 'WEAK' | 'MEDIUM' | 'STRONG'
  reasons: string[]
}
```

---

## å››ã€æ ¸å¿ƒè¶‹åŠ¿åˆ¤æ–­å‡½æ•°ï¼ˆé‡ç‚¹ï¼‰

```ts
export function calcTrend(klines: Kline[]): TrendResult {
  if (klines.length < 60) {
    return {
      trend: 'SIDEWAYS',
      score: 0,
      strength: 'WEAK',
      reasons: ['Kçº¿æ•°æ®ä¸è¶³']
    }
  }

  const closes = klines.map(k => k.close)
  const volumes = klines.map(k => k.volume)

  const ma5 = SMA(closes, 5)
  const ma10 = SMA(closes, 10)
  const ma20 = SMA(closes, 20)
  const ma60 = SMA(closes, 60)

  const ema20 = EMA(closes.slice(-25), 20)
  const ema20Prev = EMA(closes.slice(-30, -5), 20)

  const rsi = RSI(closes, 14)
  const macd = MACD(closes)

  const volumeRatio =
    volumes[volumes.length - 1] /
    SMA(volumes, 20)

  let score = 0
  const reasons: string[] = []

  /** ---------- å‡çº¿æ–¹å‘è¿‡æ»¤ ---------- */
  const bullishMA = ma5 > ma10 && ma10 > ma20 && ma20 > ma60
  const bearishMA = ma5 < ma10 && ma10 < ma20 && ma20 < ma60

  if (bullishMA) {
    score += 30
    reasons.push('å‡çº¿å¤šå¤´æ’åˆ—')
  } else if (bearishMA) {
    score -= 30
    reasons.push('å‡çº¿ç©ºå¤´æ’åˆ—')
  } else {
    return {
      trend: 'SIDEWAYS',
      score: 0,
      strength: 'WEAK',
      reasons: ['å‡çº¿æœªå½¢æˆè¶‹åŠ¿']
    }
  }

  /** ---------- EMA æ–œç‡ ---------- */
  const emaSlope = ema20 - ema20Prev
  if (emaSlope > 0) {
    score += Math.min(20, emaSlope * 1000)
    reasons.push('EMA20 å‘ä¸Š')
  } else {
    score -= Math.min(20, Math.abs(emaSlope * 1000))
    reasons.push('EMA20 å‘ä¸‹')
  }

  /** ---------- MACD åŠ¨é‡ ---------- */
  if (macd.dif > macd.dea && macd.hist > 0) {
    score += 20
    reasons.push('MACD å¤šå¤´åŠ¨é‡')
  }
  if (macd.dif < macd.dea && macd.hist < 0) {
    score -= 20
    reasons.push('MACD ç©ºå¤´åŠ¨é‡')
  }

  /** ---------- RSI ---------- */
  if (rsi > 55 && rsi < 75) {
    score += 10
    reasons.push('RSI å¥åº·åŒºé—´')
  }
  if (rsi < 45) {
    score -= 10
    reasons.push('RSI åå¼±')
  }

  /** ---------- æˆäº¤é‡ ---------- */
  if (volumeRatio > 1.2) {
    score += 20
    reasons.push('æ”¾é‡ç¡®è®¤')
  }
  if (volumeRatio < 0.8) {
    score -= 10
    reasons.push('ç¼©é‡')
  }

  score = Math.max(-100, Math.min(100, score))

  let trend: TrendResult['trend'] = 'SIDEWAYS'
  let strength: TrendResult['strength'] = 'WEAK'

  if (score >= 30) trend = 'UP'
  if (score <= -30) trend = 'DOWN'

  if (Math.abs(score) >= 60) strength = 'STRONG'
  else if (Math.abs(score) >= 30) strength = 'MEDIUM'

  return {
    trend,
    score,
    strength,
    reasons
  }
}
```

---

## äº”ã€å¦‚ä½•åœ¨ä½ ç³»ç»Ÿé‡Œç”¨ï¼ˆç¤ºä¾‹ï¼‰

```ts
const result = calcTrend(klines)

if (result.trend === 'UP' && result.strength !== 'WEAK') {
  // å…è®¸åšå¤š
}
```

---

## å…­ã€ä½ ç°åœ¨å·²ç»æ‹¥æœ‰çš„èƒ½åŠ›

âœ… **å•ä¸€è‚¡ç¥¨è¶‹åŠ¿åˆ¤æ–­**
âœ… **å¯è§£é‡Šï¼ˆreasons å¯ç›´æ¥å±•ç¤ºåœ¨ UIï¼‰**
âœ… **å¯å›æµ‹ / å¯ç­–ç•¥åŒ–**
âœ… **é€‚åˆ ETF / å¤§ç›˜ / æƒé‡è‚¡**

---

## ä¸ƒã€ä¸‹ä¸€æ­¥å¼ºçƒˆå»ºè®®ï¼ˆé€‰ä¸€ä¸ªï¼‰

1ï¸âƒ£ **åŠ ä¸Š ATR æ­¢æŸ + è¶‹åŠ¿ç ´åè§„åˆ™ï¼ˆå®ç›˜å¿…å¤‡ï¼‰**
2ï¸âƒ£ **æŠŠè¶‹åŠ¿ç»“æœå†™å…¥æ•°æ®åº“ï¼Œåšè¶‹åŠ¿å†å²å›æº¯**
3ï¸âƒ£ **æ¥è¿›ä½ çš„ Strategy å›æµ‹å¼•æ“**
4ï¸âƒ£ **å‰ç«¯åšè¶‹åŠ¿èƒŒæ™¯è‰² + åˆ†æ•°ä»ªè¡¨ç›˜**

ä½ ç›´æ¥è¯´ç¼–å·ï¼Œæˆ‘ç»§ç»­å¸®ä½ å¾€â€œå¯äº¤æ˜“ç³»ç»Ÿâ€æ¨ã€‚
