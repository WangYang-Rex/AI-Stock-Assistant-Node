好，这一步我们直接把它**工程化**。
下面是**「趋势 + 风控结果」的数据库设计方案（MySQL）**，目标只有一个：

> **可回测、可复盘、可对账、可做统计分析**

而且**完全贴合你现在已经有的趋势 / ATR / 均线逻辑**。

---

# 一、整体数据设计思路（先给你全局）

我们不搞一张万能表，而是**职责清晰的 3 张核心表**：

```
股票行情（你已有）
   ↓
趋势结果表（每日 / 每周期）
   ↓
风控结果表（止损 / 趋势破坏）
```

这样你以后想做：

* 趋势胜率统计
* 不同强度趋势的收益
* 止损是否合理
  都会非常舒服。

---

# 二、趋势结果表（最核心）

### 📌 表名

```sql
trend_signal
```

### 📌 作用

> **记录“某只股票在某一天的趋势判断结果”**

---

### 📌 表结构（可直接建表）

```sql
CREATE TABLE trend_signal (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',

  code VARCHAR(10) NOT NULL COMMENT '股票代码',
  trade_date DATE NOT NULL COMMENT '交易日',

  trend ENUM('UP', 'DOWN', 'SIDEWAYS') NOT NULL COMMENT '趋势方向',
  score INT NOT NULL COMMENT '趋势评分(-100~100)',
  strength ENUM('WEAK', 'MEDIUM', 'STRONG') NOT NULL COMMENT '趋势强度',

  ma5 DECIMAL(10,4) COMMENT 'MA5',
  ma10 DECIMAL(10,4) COMMENT 'MA10',
  ma20 DECIMAL(10,4) COMMENT 'MA20',
  ma60 DECIMAL(10,4) COMMENT 'MA60',

  ema20 DECIMAL(10,4) COMMENT 'EMA20',
  ema20_slope DECIMAL(10,6) COMMENT 'EMA20斜率',

  macd_dif DECIMAL(10,6) COMMENT 'MACD DIF',
  macd_dea DECIMAL(10,6) COMMENT 'MACD DEA',
  macd_hist DECIMAL(10,6) COMMENT 'MACD柱',

  rsi14 DECIMAL(6,2) COMMENT 'RSI14',
  volume_ratio DECIMAL(6,2) COMMENT '量比',

  reasons JSON COMMENT '趋势判断原因',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_code_date (code, trade_date)
) COMMENT='股票趋势信号表';
```

---

### 🔍 为什么字段这么设计？

* **trend / score / strength**
  → 直接用于交易 & UI

* **指标快照全部存下来**
  → 防止未来你改参数，历史对不上

* **reasons JSON**
  → 前端直接展示「为什么今天是上涨趋势」

---

# 三、风控 / 止损结果表（非常重要）

### 📌 表名

```sql
trend_risk
```

---

### 📌 表结构

```sql
CREATE TABLE trend_risk (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键',

  code VARCHAR(10) NOT NULL COMMENT '股票代码',
  trade_date DATE NOT NULL COMMENT '交易日',

  atr14 DECIMAL(10,4) COMMENT 'ATR14',

  stop_price DECIMAL(10,4) COMMENT 'ATR止损价',
  ma10 DECIMAL(10,4) COMMENT 'MA10',
  ma20 DECIMAL(10,4) COMMENT 'MA20',

  stop_triggered TINYINT(1) NOT NULL COMMENT '是否触发止损',
  stop_reason VARCHAR(100) COMMENT '止损原因',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_code_date (code, trade_date)
) COMMENT='趋势风控结果表';
```

---

### 🔥 这张表的价值

以后你可以直接统计：

* **ATR 止损是不是太紧**
* **多少次是 MA 破坏止损**
* **不同趋势强度下止损概率**

---

# 四、交易关联（和你现有交易表如何对接）

假设你已有交易表：

```sql
trade_record (
  id,
  code,
  buy_date,
  buy_price,
  sell_date,
  sell_price
)
```

### 📊 你能直接做的分析

```sql
-- 强趋势胜率
SELECT strength, COUNT(*), AVG(sell_price / buy_price - 1)
FROM trade_record t
JOIN trend_signal s
  ON t.code = s.code AND t.buy_date = s.trade_date
GROUP BY strength;
```

---

# 五、后端写入流程（强烈建议）

```ts
每日任务:
1. 拉取K线
2. calcTrend()
3. checkRisk()
4. 写 trend_signal
5. 写 trend_risk
```

> ⚠️ **永远不要运行时再算历史指标**
> 一定要**算完就存**

---

# 六、你现在已经到什么程度了？

实话说一句 👇
你现在这套已经是：

* ✅ **量化系统级别**
* ✅ **可实盘 / 可复盘**
* ✅ **可以不断优化参数**
* ❌ 唯一差的就是「仓位与加减仓策略」

---

# 七、下一步（你继续选编号）

接下来这一步会**直接决定收益曲线形态**：

2️⃣ **趋势内加仓 / 减仓规则（非常关键）**
3️⃣ **趋势可视化（K线背景色 + ATR止损线）**
4️⃣ **完整回测引擎对接（和你现有 Strategy 表融合）**

你继续回 **编号**，我一步一步把你这套推成完整的交易系统 🚀
