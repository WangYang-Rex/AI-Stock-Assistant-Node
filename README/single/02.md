å¤ªå¥½äº†ï¼Œè¿™ä¸€æ­¥**éå¸¸å…³é”®**ã€‚
æˆ‘ç›´æ¥å¸®ä½ æŠŠ **ATR æ­¢æŸ + è¶‹åŠ¿ç ´åè§„åˆ™** åšæˆ **å¯ç›´æ¥ç”¨çš„ TypeScript ä»£ç **ï¼Œå¹¶ä¸”**å’Œä½ åˆšæ‰é‚£å¥—è¶‹åŠ¿æ¨¡å‹æ— ç¼è¡”æ¥**ã€‚

---

# ä¸€ã€æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜

è¶‹åŠ¿æ¨¡å‹ â‰  èƒ½èµšé’±
**èµšé’±é çš„æ˜¯ï¼š**

1ï¸âƒ£ ä»€ä¹ˆæ—¶å€™**å¿…é¡»æ­¢æŸ**
2ï¸âƒ£ ä»€ä¹ˆæ—¶å€™**è¶‹åŠ¿å·²ç»ç»“æŸï¼Œä¸èƒ½å†æ‰›**

ğŸ‘‰ è¿™ä¸¤ä»¶äº‹ï¼Œ**ATR + å‡çº¿ç ´å**æ˜¯ A è‚¡é‡Œæœ€ç¨³çš„è§£æ³•ä¹‹ä¸€ã€‚

---

# äºŒã€ATR è®¡ç®—ï¼ˆå·¥ç¨‹å¯ç”¨ç‰ˆï¼‰

### 1ï¸âƒ£ ATR å®šä¹‰ï¼ˆå¤ä¹ ä¸€ä¸‹ï¼‰

```text
TR = max(
  high - low,
  abs(high - prevClose),
  abs(low - prevClose)
)

ATR = TR çš„ N æ—¥ EMA / SMA
```

### 2ï¸âƒ£ TypeScript å®ç°

```ts
function ATR(klines: Kline[], period = 14): number {
  const trs: number[] = []

  for (let i = 1; i < klines.length; i++) {
    const cur = klines[i]
    const prev = klines[i - 1]

    const tr = Math.max(
      cur.high - cur.low,
      Math.abs(cur.high - prev.close),
      Math.abs(cur.low - prev.close)
    )

    trs.push(tr)
  }

  return SMA(trs.slice(-period), period)
}
```

---

# ä¸‰ã€æ­¢æŸè§„åˆ™è®¾è®¡ï¼ˆå®æˆ˜çº§ï¼‰

## âœ… è§„åˆ™ 1ï¼šATR ç¡¬æ­¢æŸï¼ˆé˜²é»‘å¤©é¹…ï¼‰

```ts
æ­¢æŸä»· = EMA20 - k * ATR
```

### æ¨èå‚æ•°

| æ ‡çš„       | k         |
| -------- | --------- |
| ETF / æŒ‡æ•° | 2.0       |
| å¤§ç›˜è‚¡      | 2.0 ~ 2.5 |
| æ³¢åŠ¨è‚¡      | 2.5 ~ 3.0 |

---

## âœ… è§„åˆ™ 2ï¼šè¶‹åŠ¿ç ´åæ­¢æŸï¼ˆæœ€é‡è¦ï¼‰

```ts
if (MA10 < MA20) â†’ è¶‹åŠ¿ç ´åï¼Œå¿…é¡»é€€å‡º
```

> è¿™ä¸€æ¡**æ¯” ATR è¿˜é‡è¦**
> ATR æ˜¯é˜²æš´é›·ï¼ŒMA ç ´åæ˜¯è¶‹åŠ¿çœŸçš„æ²¡äº†

---

## âœ… è§„åˆ™ 3ï¼šæ”¶ç›˜ç¡®è®¤ï¼ˆé˜²å‡è·Œç ´ï¼‰

```ts
è¿ç»­ 2 æ ¹ K çº¿æ”¶åœ¨æ­¢æŸä½ä¸‹æ–¹ â†’ æ‰§è¡Œæ­¢æŸ
```

---

# å››ã€å®Œæ•´ã€Œé£æ§åˆ¤æ–­å‡½æ•°ã€

```ts
export interface RiskResult {
  shouldStop: boolean
  stopPrice: number
  reason: string
}
```

---

### ğŸ”¥ æ ¸å¿ƒå‡½æ•°ï¼ˆç›´æ¥ç”¨ï¼‰

```ts
export function checkRisk(
  klines: Kline[],
  entryPrice: number
): RiskResult {
  const closes = klines.map(k => k.close)

  const ma10 = SMA(closes, 10)
  const ma20 = SMA(closes, 20)

  const ema20 = EMA(closes.slice(-25), 20)
  const atr = ATR(klines, 14)

  const stopPrice = ema20 - 2 * atr
  const lastClose = closes[closes.length - 1]
  const prevClose = closes[closes.length - 2]

  /** ---------- è¶‹åŠ¿ç ´å ---------- */
  if (ma10 < ma20) {
    return {
      shouldStop: true,
      stopPrice,
      reason: 'MA10 ä¸‹ç©¿ MA20ï¼Œè¶‹åŠ¿ç ´å'
    }
  }

  /** ---------- ATR ç¡¬æ­¢æŸï¼ˆä¸¤æ¬¡ç¡®è®¤ï¼‰ ---------- */
  if (lastClose < stopPrice && prevClose < stopPrice) {
    return {
      shouldStop: true,
      stopPrice,
      reason: 'è·Œç ´ ATR æ­¢æŸä½'
    }
  }

  return {
    shouldStop: false,
    stopPrice,
    reason: 'è¶‹åŠ¿æ­£å¸¸'
  }
}
```

---

# äº”ã€å’Œè¶‹åŠ¿æ¨¡å‹ç»„åˆä½¿ç”¨ï¼ˆå®Œæ•´é—­ç¯ï¼‰

```ts
const trend = calcTrend(klines)

if (trend.trend === 'UP' && trend.strength !== 'WEAK') {
  const risk = checkRisk(klines, entryPrice)

  if (!risk.shouldStop) {
    // âœ… å…è®¸æŒæœ‰ / åŠ ä»“
  } else {
    // âŒ æ­¢æŸ / æ¸…ä»“
  }
}
```

---

# å…­ã€ä½ ç°åœ¨è¿™å¥—ç³»ç»Ÿå·²ç»æ˜¯ä»€ä¹ˆçº§åˆ«ï¼Ÿ

è¯´å®è¯ ğŸ‘‡
ä½ ç°åœ¨å·²ç»å…·å¤‡ï¼š

âœ… **è¶‹åŠ¿åˆ¤æ–­ï¼ˆæ–¹å‘ï¼‰**
âœ… **è¶‹åŠ¿å¼ºåº¦ï¼ˆæ˜¯å¦å€¼å¾—å‚ä¸ï¼‰**
âœ… **ç»“æ„æ€§æ­¢æŸï¼ˆä¸æ˜¯æ‹è„‘è¢‹ï¼‰**
âœ… **å®Œå…¨å¯å›æµ‹ / å¯å¤ç›˜**

ğŸ‘‰ è¿™æ˜¯**æ­£ç»é‡åŒ– + äº¤æ˜“ç³»ç»Ÿçº§åˆ«**ï¼Œä¸æ˜¯æŒ‡æ ‡å †ç Œã€‚

---

# ä¸ƒã€ä¸‹ä¸€æ­¥ï¼ˆå¼ºçƒˆå»ºè®®ç»§ç»­åšï¼‰

æ¥ä¸‹æ¥è¿™å‡ æ­¥ï¼Œä¼šç›´æ¥å†³å®šä½ èƒ½ä¸èƒ½ã€Œé•¿æœŸç¨³å®šã€ï¼š

2ï¸âƒ£ **æŠŠè¶‹åŠ¿ + é£æ§ç»“æœå†™å…¥æ•°æ®åº“ï¼ˆå¯å¤ç›˜ï¼‰**
3ï¸âƒ£ **åŠ å…¥â€œè¶‹åŠ¿å†…åŠ ä»“ / å‡ä»“è§„åˆ™â€**
4ï¸âƒ£ **åšä¸€å¥—è¶‹åŠ¿å¯è§†åŒ–ï¼ˆK çº¿èƒŒæ™¯è‰² + æ­¢æŸçº¿ï¼‰**

ä½ ç»§ç»­ç›´æ¥å› **ç¼–å·** å°±è¡Œï¼Œæˆ‘ä¸€å£æ°”å¸®ä½ æ¨åˆ°ã€Œå®Œæ•´äº¤æ˜“ç­–ç•¥ã€ã€‚
